name: Deployment Validation

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Static Analysis Job
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Pylint
      continue-on-error: true
      run: |
        cd backend
        pylint app/ --rcfile=.pylintrc --exit-zero --output-format=colorized

    - name: Run MyPy Type Checking
      continue-on-error: true
      run: |
        cd backend
        mypy --config-file=mypy.ini --show-error-codes

    - name: Run Bandit Security Analysis
      continue-on-error: true
      run: |
        cd backend
        bandit -r app/ -c .bandit -f screen

    - name: Check Code Formatting (Black)
      run: |
        cd backend
        black --check app/ tests/ || echo "Code formatting issues found (not failing build)"

  # Deployment Tests Job
  deployment-tests:
    name: Deployment Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: timescale/timescaledb:2.13.0-pg15
        env:
          POSTGRES_USER: glucolens
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: glucolens_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7.2.3-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up test database
      env:
        DATABASE_URL: postgresql+asyncpg://glucolens:test_password@localhost:5432/glucolens_test
      run: |
        cd backend
        # Run database initialization
        PGPASSWORD=test_password psql -h localhost -U glucolens -d glucolens_test -f migrations/init.sql || true

    - name: Run Deployment Tests
      env:
        DATABASE_URL: postgresql+asyncpg://glucolens:test_password@localhost:5432/glucolens_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
        CELERY_BROKER_URL: redis://localhost:6379/0
        CELERY_RESULT_BACKEND: redis://localhost:6379/0
      run: |
        cd backend
        pytest tests/test_deployment.py -v --tb=short --maxfail=5

    - name: Test Import All Modules
      env:
        DATABASE_URL: postgresql+asyncpg://glucolens:test_password@localhost:5432/glucolens_test
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
      run: |
        cd backend
        python -c "from app.main import app; print('✓ Main app imported successfully')"
        python -c "from app.database import engine; print('✓ Database configured successfully')"
        python -c "from app.tasks import celery_app; print('✓ Celery configured successfully')"

  # Docker Build Job
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v6
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: false
        tags: glucolens-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm glucolens-backend:test python -c "import app.main; print('Docker image working!')"

  # Frontend Tests Job
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      continue-on-error: true
      run: npm run lint

    - name: Check TypeScript compilation
      run: npx tsc --noEmit

    - name: Build frontend
      run: npm run build

  # Security Scanning Job
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner (Docker)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: './backend'
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

  # Dependency Check Job
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install safety
      run: pip install safety

    - name: Check Python dependencies for vulnerabilities
      continue-on-error: true
      run: |
        cd backend
        safety check -r requirements.txt --json || true

    - name: Run npm audit
      continue-on-error: true
      run: npm audit --audit-level=high || true

  # Summary Job
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, deployment-tests, docker-build, frontend-tests, security-scan, dependency-check]
    if: always()

    steps:
    - name: Check job statuses
      run: |
        echo "==================================="
        echo "Deployment Validation Summary"
        echo "==================================="
        echo ""
        echo "Static Analysis: ${{ needs.static-analysis.result }}"
        echo "Deployment Tests: ${{ needs.deployment-tests.result }}"
        echo "Docker Build: ${{ needs.docker-build.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Dependency Check: ${{ needs.dependency-check.result }}"
        echo ""
        echo "==================================="

    - name: Fail if critical jobs failed
      if: |
        needs.deployment-tests.result == 'failure' ||
        needs.docker-build.result == 'failure' ||
        needs.frontend-tests.result == 'failure'
      run: |
        echo "Critical jobs failed - deployment validation failed"
        exit 1
